name: Release Build

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  package:
    runs-on: windows-latest  # ä½¿ç”¨ Windows ç¯å¢ƒ

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

#      - name: ğŸ› ï¸ å®‰è£… Python 3.10
#        uses: actions/setup-python@v4
#        with:
#          python-version: '3.10'
#
#      - name: ğŸ› ï¸ å®‰è£… Poetry
#        run: |
#          # ä½¿ç”¨ pip å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Poetryï¼ˆé€‚ç”¨äº Windowsï¼‰
#          python -m pip install --upgrade poetry==2.1.1

      - name: ğŸ“¦ å®‰è£… 7z
        run: |
          choco install 7zip  # ä½¿ç”¨ Chocolatey å®‰è£… 7zip

      - name: ğŸ“– è·å– pyproject.toml ä¸­çš„ç‰ˆæœ¬å·
        id: get_version
        run: |
          # ä½¿ç”¨ PowerShell æ­£ç¡®è®¾ç½®ç¯å¢ƒå˜é‡
          $version = (Select-String -Path "pyproject.toml" -Pattern 'version = "(.*)"').Matches.Groups[1].Value
          $version = "$version"
          Write-Output "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append


#      - name: ğŸ§‘â€ğŸ’» åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼Œå¹¶å®‰è£…ä¾èµ–
#        run: |
#          # åˆ›å»ºåä¸º venv çš„è™šæ‹Ÿç¯å¢ƒï¼Œä½äºé¡¹ç›®æ ¹ç›®å½•
#          python -m venv venv
#          # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
#          .\venv\Scripts\activate
#          # å®‰è£… Poetry ä¾èµ–
#          poetry install

#      - name: ğŸ› ï¸ åˆ›å»ºä¾¿æºå¼è™šæ‹Ÿç¯å¢ƒ
#        run: |
#          # ä½¿ç”¨ --copies å‚æ•°é¿å…ç¬¦å·é“¾æ¥
#          python -m venv venv --copies
#
#          # æ¿€æ´»æ—¶ä½¿ç”¨ç›¸å¯¹è·¯å¾„
#          .\venv\Scripts\activate
#
#          # ä¿®å¤æ¿€æ´»è„šæœ¬çš„è·¯å¾„
#          (Get-Content .\venv\Scripts\activate) -replace 'VIRTUAL_ENV=.*', 'VIRTUAL_ENV="$(dirname "$(dirname "$(realpath "$0")")")"' | Set-Content .\venv\Scripts\activate
#
#          poetry install

      - name: ğŸ—œï¸ åˆ›å»º 7z å‹ç¼©åŒ…ï¼ˆåŒ…å«è™šæ‹Ÿç¯å¢ƒï¼‰
        run: |
          Remove-Item -Path ".git" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path ".github" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "assets/screenshot" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "docs" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "logs" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "tests" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "src/gui/resource" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path ".pre-commit-config.yaml" -Recurse -Force -ErrorAction SilentlyContinue
          7z a -mx=9 "wwa-${{ env.VERSION }}.7z" .

      - name: ğŸ“‚ ä¸Šä¼  7z æ–‡ä»¶ä½œä¸º Workflow äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: release-7z
          path: "wwa-${{ env.VERSION }}.7z"

      - name: ğŸš€ å‘å¸ƒ GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          name: "Pre release ${{ env.VERSION }}"
          files: "wwa-${{ env.VERSION }}.7z"
          body: |
            Wuthering Waves Assistant
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
